# CLAUDE.md

## 项目概览
本项目是一个基于 Next.js 的大模型安全共识平台，集成了北京智源人工智能研究院的大模型安全研究中心的相关工作。

## 技术规范与文档索引

### 📚 核心文档
- **文档中心**: @./docs/README.md - 文档总览和快速导航
- **项目概述**: @./docs/PROJECT_OVERVIEW.md - 项目背景、技术栈、架构特点
- **项目结构**: @./docs/PROJECT_STRUCTURE.md - 目录结构、路由映射、文件索引
- **核心模块**: @./docs/CORE_MODULES.md - 数据层、类型系统、组件层、路由层详解
- **数据流说明**: @./docs/DATA_FLOW.md - 数据流转过程、API 迁移指南
- **开发规范**: @./docs/DEV_GUIDELINES.md - 页面、组件、样式、TypeScript 规范
- **常见任务**: @./docs/COMMON_TASKS.md - 常见开发操作的步骤和代码示例

### 📖 快速查阅指南

**根据任务类型选择文档：**

| 任务类型 | 查看文档 |
|---------|----------|
| 第一次了解项目 | `./docs/README.md` → `./docs/PROJECT_OVERVIEW.md` |
| 查找特定文件位置 | `./docs/PROJECT_STRUCTURE.md` |
| 添加新功能/页面 | `./docs/DEV_GUIDELINES.md` → `./docs/COMMON_TASKS.md` |
| 理解代码组织方式 | `./docs/CORE_MODULES.md` |
| 了解数据如何流转 | `./docs/DATA_FLOW.md` |
| 添加研究项目/新闻 | `./docs/COMMON_TASKS.md` |
| 修改导航/样式 | ./docs/COMMON_TASKS.md |

## 最佳实践与维护策略

### 代码修改流程
1. **理解需求** - 询问用户具体需求和期望效果
2. **查阅文档** - 根据上表选择合适的文档进行查阅，理解相关模块
3. **定位代码** - 使用 `@./docs/PROJECT_STRUCTURE.md` 中的文件索引快速定位
4. **执行修改** - 遵循 `./docs/DEV_GUIDELINES.md` 中的开发规范
5. **实现后审查** - 完成功能后，根据架构变化分类检查是否需要更新文档
6. **更新文档** - 如有架构变化，同步更新相关文档

### 架构变化分类与触发条件

#### 🔴 大型架构变化（必须全面更新文档）

**定义：**影响多个核心模块或引入新的系统层级的变化

**识别标准：**
- ✅ 新增核心功能模块（如 MDX 内容系统、认证系统、API 层）
- ✅ 修改数据流转方式（如从静态到 API、新增中间层）
- ✅ 新增目录或重组项目结构（如添加 `/content/`、`/api/`）
- ✅ 引入新的技术栈组件（如 MDX、数据库、状态管理）
- ✅ 修改路由架构或页面渲染方式

**必须更新的文档：**
- ✅ `PROJECT_OVERVIEW.md` - 更新技术栈、项目特点、架构特点
- ✅ `PROJECT_STRUCTURE.md` - 更新目录结构、文件索引、页面组件对应表
- ✅ `CORE_MODULES.md` - 新增或更新模块说明
- ✅ `DATA_FLOW.md` - 更新数据流程图和流程说明
- ✅ `DEV_GUIDELINES.md` - 添加新模块的开发规范
- ⚠️ `COMMON_TASKS.md` - 添加相关常见任务示例

#### 🟡 中型架构变化（选择性更新文档）

**定义：**影响单个模块但不改变整体架构的变化

**识别标准：**
- ✅ 新增数据类型或修改现有类型（`types/`）
- ✅ 新增或修改工具函数（`lib/`）
- ✅ 新增组件分类（如新增 MDX 组件目录）
- ✅ 修改现有页面的数据来源或渲染方式

**建议更新的文档：**
- ✅ `PROJECT_STRUCTURE.md` - 如有新文件或目录
- ✅ `CORE_MODULES.md` - 如修改了核心模块实现
- ⚠️ `COMMON_TASKS.md` - 如影响常见开发任务

#### 🟢 小型变化（无需更新架构文档）

**定义：**不影响架构的内容或样式调整

**识别标准：**
- ✅ 修改样式或主题颜色
- ✅ 添加/修改静态数据内容（`data/` 中的具体数据）
- ✅ 修改文案或翻译
- ✅ Bug 修复（不改变设计）

**无需更新文档**（除非 bug 修复涉及架构问题）

### 实现后审查步骤（暂停检查点）

**触发时机：**
- 新功能实现完成后
- 多文件修改完成后
- 新模块添加完成后

**检查清单：**

```markdown
## 架构变化审查

### 1. 确定变化类型
- [ ] 大型架构变化（新增模块/系统层级/技术栈）
- [ ] 中型架构变化（修改单个模块实现）
- [ ] 小型变化（内容/样式调整）

### 2. 新增文件检查
- [ ] 是否新增目录？→ 更新 PROJECT_STRUCTURE.md
- [ ] 是否新增核心文件？→ 更新文件索引表
- [ ] 是否新增组件分类？→ 更新 CORE_MODULES.md

### 3. 数据流变化检查
- [ ] 是否改变数据加载方式？→ 更新 DATA_FLOW.md
- [ ] 是否新增数据源？→ 更新数据流程图
- [ ] 是否修改页面渲染流程？→ 更新 DATA_FLOW.md 和 CORE_MODULES.md

### 4. 技术栈变化检查
- [ ] 是否新增依赖包？→ 更新 PROJECT_OVERVIEW.md 关键依赖
- [ ] 是否引入新技术（MDX/数据库/状态管理）？→ 更新项目特点和架构特点
- [ ] 是否修改构建配置？→ 更新 PROJECT_OVERVIEW.md

### 5. 开发规范变化检查
- [ ] 是否需要新的开发规范？→ 更新 DEV_GUIDELINES.md
- [ ] 是否有新的常见任务？→ 更新 COMMON_TASKS.md
- [ ] 是否改变组件/文件命名规范？→ 更新 DEV_GUIDELINES.md

### 6. 版本号更新
- [ ] 修改文档的版本号 +0.1（如 1.0 → 1.1）
- [ ] 更新文档日期
```

### 文档维护规则（细化版）

#### 具体触发条件

| 变化类型 | 触发条件 | 必须更新的文档 |
|---------|---------|---------------|
| **新增内容系统** | 添加 MDX/CMS/内容管理 | PROJECT_OVERVIEW, PROJECT_STRUCTURE, CORE_MODULES, DATA_FLOW, DEV_GUIDELINES |
| **新增技术栈** | 引入新库/框架 | PROJECT_OVERVIEW (关键依赖), CORE_MODULES (如有新模块) |
| **新增目录** | 创建新的顶层目录 | PROJECT_STRUCTURE (目录结构、职责说明) |
| **新增核心文件** | 添加关键工具/模块 | PROJECT_STRUCTURE (文件索引), CORE_MODULES |
| **修改数据流** | 改变数据加载/渲染方式 | DATA_FLOW (流程图), CORE_MODULES (路由层) |
| **新增页面** | 添加新路由页面 | PROJECT_STRUCTURE (路由映射表) |
| **新增组件分类** | 创建新的组件目录 | CORE_MODULES (组件层) |
| **新增开发规范** | 引入新的编写约定 | DEV_GUIDELINES |
| **新增常见任务** | 用户可能重复的操作 | COMMON_TASKS |

#### 文档更新示例

**场景 1：添加 MDX 内容系统**
```markdown
✅ 更新 PROJECT_OVERVIEW.md:
   - 关键依赖添加 @mdx-js/mdx, next-mdx-remote 等
   - 项目特点添加"MDX 内容管理系统"
   - 新增"内容层设计"架构特点章节

✅ 更新 PROJECT_STRUCTURE.md:
   - 目录结构添加 content/ 和 lib/mdx.ts
   - 文件索引添加 MDX 相关文件
   - 页面组件对应表添加 MDX 渲染说明

✅ 更新 CORE_MODULES.md:
   - 新增"内容层"模块章节
   - 更新路由层示例展示 MDX 渲染

✅ 更新 DATA_FLOW.md:
   - 添加 MDX 内容加载流程图
   - 新增"研究项目详情页数据流"章节

✅ 更新 DEV_GUIDELINES.md:
   - 新增"MDX 内容编写规范"章节
```

**场景 2：新增 API 层**
```markdown
✅ 更新 PROJECT_OVERVIEW.md:
   - 技术栈添加 API 框架
   - 架构特点添加"API 层设计"

✅ 更新 PROJECT_STRUCTURE.md:
   - 目录结构添加 app/api/
   - 路由映射表添加 API 路由

✅ 更新 DATA_FLOW.md:
   - 修改数据流程图（静态 → API）
   - 更新"未来 API 迁移"章节状态
```

### 注意事项
- ⚠️ **不要直接搜索代码**：先查阅文档理解结构，再精准定位
- ⚠️ **实现后必须审查**：功能完成后，使用"实现后审查步骤"检查是否需要更新文档
- ⚠️ **文档版本控制**：修改文档时更新版本号和日期
- ✅ **优先使用文档索引**：使用 PROJECT_STRUCTURE.md 的文件索引表快速查找
- ✅ **遵循现有规范**：查看 DEV_GUIDELINES.md 保持代码一致性
- ✅ **参考常见任务**：类似操作参考 COMMON_TASKS.md 中的示例
- ✅ **架构变化分类**：根据变化类型确定需要更新的文档范围

## 为什么需要这些规则？

### 之前的问题
在实现 MDX 集成时，我们发现：
1. 没有明确的"暂停检查点"，导致忘记更新文档
2. 对"架构变化"的定义模糊，不确定何时需要更新文档
3. 文档更新规则太笼统，缺少具体的触发条件

### 改进后的优势
- ✅ 明确的架构变化分类（大型/中型/小型）
- ✅ 具体的文档更新检查清单
- ✅ 实现后审查步骤作为暂停检查点
- ✅ 每种变化类型都有明确的文档更新范围